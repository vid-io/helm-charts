{{- $routes := .Values.routes }}
{{- range $host, $services := $routes }}
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ $.Values.name }}-{{ $host | replace "." "-" }}
  namespace: {{ $.Values.namespace }}
spec:
  hostnames:
    - {{ $host }}
  parentRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: gateway
      namespace: gateway
  rules:
    {{- range $serviceName, $service := $services }}
    {{- $paths := $service.paths }}
    {{- $numPaths := (len $paths) }}
    {{- $batches := (div $numPaths 7) }}
    {{- range $i := until ($batches| int) }}
    - backendRefs:
        - group: ""
          kind: Service
          name: {{ $serviceName }}
          port: {{ $service.port | default 80}}
      matches:
        {{- $start := mul $i 7 }}
        {{- $end := min (add $start 7) $numPaths }}
        {{- range $index, $path := (slice $paths $start $end) }}
        - path:
            {{- if not $path.features }}
            type: PathPrefix
            value: {{ $path.name }}
            {{- end }}
        {{- end }}
      timeouts:
        backendRequest: 60s
        request: 60s
    {{- end }}
  {{- end }}
{{- end }}
---
{{- range $host, $services := $routes }}
{{- range $serviceName, $service := $services }}
{{- $paths := $service.paths }}
{{- range $path := $paths }}
{{- if $path.features }}
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ $path.name | replace "/" ""}}-{{ $host | replace "." "-" }}
  namespace: {{ $.Values.namespace }}
spec:
  hostnames:
    - {{ $host }}
  parentRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: gateway
      namespace: gateway
  rules:
    - backendRefs:
        - group: ""
          kind: Service
          name: {{ $serviceName }}
          port: {{ $service.port }}
      matches:
        - path:
            type: PathPrefix
            value: {{ $path.name }}
      timeouts:
        backendRequest: 60s
        request: 60s
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: BackendTrafficPolicy
metadata:
  name: {{ $path.name | replace "/" ""}}-{{ $host | replace "." "-" }}
  namespace: {{ $.Values.namespace }}
spec:
  {{- if $path.features.gzip }}
  gzip: true
  {{- end }}
  {{- if $path.features.retries }}
  retry:
    numRetries: {{ $path.features.retries.number | default 3 }}
    {{- if $path.features.retries.http_status_code }}
    retryOn:
      httpStatusCodes:
        - 500
      triggers:
        - connect-failure
        - retriable-status-codes
    {{- end }}
  {{- end }}
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: {{ $path.name | replace "/" ""}}-{{ $host | replace "." "-" }}
    namespace: {{ $.Values.namespace }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}